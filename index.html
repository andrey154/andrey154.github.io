<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<body>
<h1>Finnish declensions trainer</h1>
Select training scenario:
<br/>
<select id="decl_to_test" onchange="UpdateFormNames()">
  <option value="nom_sg->par_sg">nom/partitive singular</option>
  <option value="nom_sg->par_pl">nom/partitive plural</option>
  <option value="nom_sg->gen_sg">nom/genetive singular</option>
  <option value="nom_sg->gen_pl">nom/genetive plural</option>
  <option value="nom_sg->ill_sg">nom/illative singular</option>
  <option value="nom_sg->ill_pl">nom/illative plural</option>

  <option value="par_sg->nom_sg">partitive singular/nom</option>
  <option value="par_pl->nom_sg">partitive plural/nom</option>
  <option value="gen_sg->nom_sg">genetive singular/nom</option>
  <option value="gen_pl->nom_sg">genetive plural/nom</option>
  <option value="ill_sg->nom_sg">illative singular/nom</option>
  <option value="ill_pl->nom_sg">illative plural/nom</option>
  <option value="random">random/random</option>
</select>
<br/>
<button type="button" style="height:40px;width:200px" onclick=ChooseNominatiivi()>Next word</button>
<div id="question_form_text"></div>
<div id="question_text"></div>
Type
<br/>
<div id="answer_form_text"></div> 
<input id="answer_input" type="text"> <br/>
<button type="button" onclick=ShowResult()>submit answer</button>
<div id="answer_text"></div>

<script src="./lua.vm.js"></script>

<script>
var answer_correct;

var form_names = { 
'nom_sg': 'Nominatiivi', 
'gen_sg': 'Yksiko genetiivi',
'gen_pl': 'Moniko genetiivi',
'par_sg': 'Yksiko partitiivi',
'par_pl': 'Moniko partitiivi',
'ill_sg': 'Yksiko illatiivi',
'ill_pl': 'Moniko illatiivi'
};


var scenarios = { 
'nom_sg->par_sg': { 'question_form': 'nom_sg', 'answer_form': 'par_sg'},
'nom_sg->par_pl': { 'question_form': 'nom_sg', 'answer_form': 'par_pl'},
'nom_sg->gen_sg': { 'question_form': 'nom_sg', 'answer_form': 'gen_sg'},
'nom_sg->gen_pl': { 'question_form': 'nom_sg', 'answer_form': 'gen_pl'},
'nom_sg->ill_sg': { 'question_form': 'nom_sg', 'answer_form': 'ill_sg'},
'nom_sg->ill_pl': { 'question_form': 'nom_sg', 'answer_form': 'ill_pl'},
'par_sg->nom_sg': { 'question_form': 'par_sg', 'answer_form': 'nom_sg'},
'par_pl->nom_sg': { 'question_form': 'par_pl', 'answer_form': 'nom_sg'},
'gen_sg->nom_sg': { 'question_form': 'gen_sg', 'answer_form': 'nom_sg'},
'gen_pl->nom_sg': { 'question_form': 'gen_pl', 'answer_form': 'nom_sg'},
'ill_sg->nom_sg': { 'question_form': 'ill_sg', 'answer_form': 'nom_sg'},
'ill_pl->nom_sg': { 'question_form': 'ill_pl', 'answer_form': 'nom_sg'},
'random': { 'question_form': 'ill_pl', 'answer_form': 'nom_sg' }
};

</script>

<script type="text/lua">

local pprint = require('pprint')
require('nouns')
require('fi_decls')


function print_form(index, form)
 local data = {forms = {}, title = nil, categories = {}}
 local args = decls[index][2]
 inflections[decls[index][1]](args, data)
 postprocess(args,data)
 pprint(data["forms"][form])
end

function print_form_and_update_result(index, form, answer) 
  local data = {forms = {}, title = nil, categories = {}}
  local args = decls[index][2]
  inflections[decls[index][1]](args, data)
  postprocess(args,data)
  pprint(data["forms"][form])
  local check = 0
  for i, possible in ipairs(data["forms"][form]) do
    if string.upper(possible) == string.upper(answer) then
      check = 1
    end
  end
  js.global:eval('answer_correct = ' .. check)
end

</script>

<script>
var outputElement = document.getElementById('answer_text')
function setOutput(element) {
 outputElement = document.getElementById(element)
 emscripten.print = function(x) {
   outputElement.textContent =  outputElement.textContent + x;
 }
}

var random_index;

function UpdateFormNames() {
  var current_scenario = document.getElementById('decl_to_test').value;
  var question_form = scenarios[current_scenario]['question_form'];
  var answer_form = scenarios[current_scenario]['answer_form'];
  document.getElementById('question_form_text').textContent = form_names[question_form];
  document.getElementById('answer_form_text').textContent = form_names[answer_form];
}

function ShowResult() {
  var current_scenario = document.getElementById('decl_to_test').value;
  var answer_form = scenarios[current_scenario]['answer_form'];
  document.getElementById('answer_form_text').textContent = form_names[answer_form];
  var answer = document.getElementById('answer_input').value;
  document.getElementById('answer_text').innerHTML = "";

  setOutput('answer_text');
  L.execute('print_form_and_update_result(' + random_index + ', "' + answer_form + '","' + answer + '")');
  if( answer_correct == 1 ) { alert("correct"); } 
  else { alert("wrong"); }
}

function UpdateRandomScenarioForms() {
  var form_keys = Object.keys(form_names);
  var form_keys_len = form_keys.length;

  var q = Math.floor(Math.random() * form_keys_len) ;
  var a;
  var cnt = 0;
  var ok = 0;
  do {
    a = Math.floor(Math.random() * form_keys_len) ;
    if( a !== q ) {  break; } 
    cnt = cnt + 1;
    if( cnt > 10 ) { 
      a=1; 
      q=1; 
      break; 
    }
  } while ( cnt < 10 )
  scenarios['random'] = { 'question_form': form_keys[q], 'answer_form': form_keys[a] };
}

function ChooseNominatiivi() {
  var current_scenario = document.getElementById('decl_to_test').value;
  if( current_scenario === 'random' ) UpdateRandomScenarioForms();
  var question_form = scenarios[current_scenario]['question_form'];
  var answer_form = scenarios[current_scenario]['answer_form'];
  document.getElementById('question_form_text').textContent = form_names[question_form];
  document.getElementById('answer_form_text').textContent = form_names[answer_form];
  document.getElementById('question_text').textContent = "";
  document.getElementById('answer_input').value = "";
  document.getElementById('answer_text').innerHTML = "";
  setOutput('question_text');
  var max_var = 30284;
  var ok = 1;
  var cnt;
  do {
    ok = 1;
    random_index = Math.floor(Math.random() * max_var) + 1;
    cnt = cnt + 1;
    if( cnt === 10 ) {  break; }
    try {
      var lua_command = 'print_form(' + random_index + ', "' + question_form + '")';
      L.execute(lua_command);
    } catch(e) {
      ok = 0;
      console.log("failed " + random_index);
    }
  } while ( ok != 1 )
}

</script>


</body></html>
