<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<body>
<h1>Trainer of Finnish declensions.</h1>
Nominative:
<div id="question">    
</div>
<button type="button" onclick=ChooseNominatiivi()>Next</button>
<br/>
<select id="decl_to_test">
  <option value="gen_sg">genitive singular</option>
  <option value="gen_pl">genitive plural</option>
  <option value="par_sg">partitive singular</option>
  <option value="par_pl">partitive plural</option>
  <option value="ill_sg">illative singular</option>
  <option value="ill_pl">illative plural</option>
</select>
<br/>
<input id="answerbox" type="text"> <br/>
<button type="button" onclick=ShowResult()>submit answer</button>
<div id="output">    
</div>

<script src="./lua.vm.js"></script>

<script>
var answer_is;
</script>

<script type="text/lua">

local pprint = require('pprint')
require('nouns')
require('fi_decls')


function print_form(index, field)
 local data = {forms = {}, title = nil, categories = {}}
 local args = decls[index][2]
 inflections[decls[index][1]](args, data)
 postprocess(args,data)
 pprint(data["forms"][field])
end

function print_form_and_update_result(index, field, answer) 
  local data = {forms = {}, title = nil, categories = {}}
  local args = decls[index][2]
  inflections[decls[index][1]](args, data)
  postprocess(args,data)
  pprint(data["forms"][field])
  local check = 0
  for i, possible in ipairs(data["forms"][field]) do
    if string.upper(possible) == string.upper(answer) then
      check = 1
    end
  end
  js.global:eval('answer_is = ' .. check)
end

</script>

<script>
var outputElement = document.getElementById('output')
function setOutput(element) {
 outputElement = document.getElementById(element)
 emscripten.print = function(x) {
   outputElement.textContent =  outputElement.textContent + x;
 }
}

var random_index;

function ShowResult() {
  var decl = document.getElementById('decl_to_test').value;
  var answer = document.getElementById('answerbox').value;
  document.getElementById('output').innerHTML = "";

  setOutput('output');
  L.execute('print_form_and_update_result(' + random_index + ', "' + decl + '","' + answer + '")');
  if( answer_is == 1 ) { alert("correct"); } 
  else { alert("wrong"); }
}

function ChooseNominatiivi() {
  document.getElementById('question').textContent = "";
  document.getElementById('answerbox').value = "";
  document.getElementById('output').innerHTML = "";
  setOutput('question');
  var max_var = 37761;
  var ok = 1;
  var cnt;
  do {
    ok = 1;
    random_index = Math.floor(Math.random() * max_var) + 1;
    cnt = cnt + 1;
    if( cnt === 10 ) {  break; }
    try {
    L.execute('print_form(' + random_index + ', "nom_sg")');
    } catch(e) {
      ok = 0;
      console.log("failed " + random_index);
    }
  } while ( ok != 1 )
}

</script>


</body></html>
